UPGRADE GUIDE: FreePiano 1.8 -> 2.2.2.1

概述
----
本指南汇总了将 FreePiano 从仓库中现有的 1.8 版本升级到目标版本 2.2.2.1 所需的功能补齐、Bug 修复和工程化工作。

注意：仓库当前仅包含 1.8 源码，官方 2.2.2.1 的完整源码/二进制未包含于本仓库，下面的指南用于指导代码修改、补丁实现与测试以达到或接近 2.2.2.1 的特性。

未实现更新内容 1.9 -> 2.2.2
----------------
**2015-05-09 Freepiano 2.2.2**
* 添加了打开 MIDI 文件的功能。
* 修复了 64 位下输出设备保存错误的 Bug。
* 修复了在关闭软件时一些音源会出错的 Bug。

**2014-03-14 Freepiano 2.2.1**
* 音源加载错误时会提示详细信息。
* 添加一个空音频输出。
* 如果按键上同时绑定了命令和音符，会优先显示音符。
* 修正 LYT 文件读取错误的 Bug。
* 修正序列标签没有被保存到 fpm 中的 Bug。
* 添加了一些示范曲。

**2014-03-06 Freepiano 2.2**
* 添加“序列”命令，可以在不切换分组的情况下定义每次按下一个键的功能。
* 按键绑定现在同时支持升记号和降记号。
* 同时发布 64 位版本。
* 添加了 MID 文件导出功能。
* 添加了“发送按键”命令，可以向别的程序发送按键，预设中添加了默认对于 Windows 照片查看器的翻页绑定。
* 添加了“菜单”命令，可以使用键盘激活主菜单，给大部分菜单加入了快捷键。
* 添加了一个“释放”改值法，可以在任何一个按键抬起后将值恢复，用于更精确地模拟踏板。
* 添加了“通道音量”和“通道声像”命令，在演奏菜单中也可以更改音量和声像。
* 添加了“弯音”命令的“平滑”设置。
* 添加了循环播放的功能。
* 添加了一个“最大化时全屏”的选项，可以在最大化时盖住任务栏。
* 恢复默认布局是可以恢复成固定唱名布局（不使用变调功能）。
* 随机力度的参数会被保存到配置文件中。
* 键盘布局菜单增加对子目录的支持。
* 修正通道选择界面输入通道选择的 bug。
* 修正按键配置窗口使用某些输入法是中文出现乱码的 bug。

**2013-11-18 Freepiano 2.1.1**
* 修复了 ASIO 输出不能工作的问题。
* 修复了更新检测失败时程序会崩溃的问题。
* 修复了英文版中的一个拼写错误。

**2013-11-01 Freepiano 2.1**
* 新增鼠标锁定命令，可以鼠标当成延音踏板来使用。
* 添加 SF2 音源的支持，可以加载 sf2 综合音源。
* 添加后台演奏模式，可以在 Freepiano 主窗口不激活或最小化的状态下演奏。
* 添加 MINI 显示模式，可以将主窗口缩小显示。
* 将移调显示为曲调，并且和五线谱中的曲调同步。
* 修正了使用 MIDI 键盘时无法录音的 BUG。
* 修正了输入通道选择后仍然修改原来的通道属性的 BUG。
* 修正了与一些音源不兼容的 BUG。

**2013-09-28 Freepiano 2.0**
* 全新的界面，包括标题栏，菜单和设置界面。
* 新的 wasapi 独占模式，能够在支持 wasapi 的系统中获得较低的延迟。
* 更好的 ASIO 支持， 现在在 ASIO 的设置面板中修改属性，Freepiano 中的属性也会直接改变。
* 修正了 VSTi 音源的兼容性问题， Freepiano 现在能正确的加载象牙等音源了。
* 增加了录音文件回放时的控制功能，可以从任意时间播放。
* 增加了五线谱记谱功能，选择五线谱界面后弹奏会记下当前弹奏的音符。
* 增加了一个内置的节拍器。
* 导出功能修改为插件，允许用户自己实现导出功能。
* 随机力度功能，可以在当前力度上再叠加一个按键力度。

优先级与时间线
----------------
- Critical（优先）：保证稳定性与基础功能
  - 修复 64-bit 下输出设备配置保存问题
  - 修复退出/卸载时音源（VST/SF2 等）导致的崩溃
  - 修复 ASIO 输出相关问题
  - 修复更新检测失败导致崩溃
- Important（次优先）：用户可见特性与兼容
  - 弹性 VST 错误提示与日志
  - 支持打开 MIDI 文件与导出 MIDI
  - 支持 SF2（SoundFont）音源（集成 FluidSynth）
  - 实现“序列”命令、发送按键、菜单命令
- Optional（可选）：工程化与增强
  - CI、自动构建、打包
  - 增强文档、示例曲、性能优化

关键改动清单（摘要）
-------------------
1. 修复 config 的设备持久化（保存 device name 而非指针/句柄；确保跨 x86/x64 可读）
2. 在关闭流程中，先停止音频输出与播放线程，等待回调完成，再卸载插件/释放 DLL
3. 在 VST 加载/卸载中增加详细错误码和可读错误信息用于 GUI 提示
4. 为 update_check_async 添加异常处理与超时保护
5. 新增 MIDI 文件导入/导出模块（SMF parser/writer）
6. 新增 SF2 支持（建议集成 FluidSynth）
7. 键映射/脚本增强：序列命令、sendkey、menu、release 恢复、bend 平滑、升/降记号
8. GUI/UX：MINI 模式、最大化全屏选项、保存随机力度参数、键盘布局对子目录支持
9. 构建：提供 Win32/x64 构建支持，编写 `BUILD.md` 指南与自动化脚本（CI）

实现细节（重点）
-----------------
- plugin 卸载顺序：
  1. 通知 UI 停止播放（song_stop_playback）
  2. 停止音频设备输出并等待回调返回（signal/flag）
  3. 锁住 vsti 线程锁，调用 effStopProcess、effEditClose、effClose
  4. delete[] temp buffers
  5. FreeLibrary(module)

- config 保存/加载：避免保存内存地址或依赖平台字长类型；确定使用 UTF-8 或 UTF-16 并统一使用转换

- VST 错误提示：在 `vsti_load_plugin` 各失败点返回可解释错误码，并由 GUI 处用 MessageBox 显示描述与建议（例如："插件与应用位数不匹配（32-bit vs 64-bit）"）

测试要点
--------
- 在 x86/x64 上 round-trip 测试 config 保存/加载
- 退出时插件不会导致崩溃（加载常见插件、播放、退出）
- ASIO/WASAPI/DirectSound 在不同设备下能正常选中并保存
- 导入/导出 MIDI 的正确性（外部工具检验）

逐步实施建议
--------------
1. 优先实现 plugin 卸载与 config 保存修复（保证稳定）
2. 修复 update 检查异常处理
3. 增强 VST 加载提示与日志
4. 在稳定后逐步实现 MIDI 导入/导出与 SF2 支持
5. 完成用户可见特性（UI/脚本扩展）
6. 最后补充 CI、BUILD 文档与打包

参考
----
- 本仓库源码（1.8）位于 repo 根的 `src/`、`vc/` 等目录
- BUILD 细节请见仓库根的 `BUILD.md`